import { useState, useEffect, useRef } from 'react'
import { Link, useNavigate, useLocation } from 'react-router-dom'
import { Bell, Menu, User, X, Building, ChevronDown, Users, Handshake, Info, Gift } from 'lucide-react'
import { SolwaveHeaderLogo } from '../brand/SolwaveLogo'

/**
 * Header Component
 * @description Main navigation header with Solwave branding
 * Features responsive design, user authentication, and dropdown menus
 */
export function Header() {
  const [isMenuOpen, setIsMenuOpen] = useState(false)
  const [isMoreDropdownOpen, setIsMoreDropdownOpen] = useState(false)
  const navigate = useNavigate()
  const location = useLocation()
  const dropdownRef = useRef<HTMLDivElement>(null)
  const moreButtonRef = useRef<HTMLButtonElement>(null)

  // Mock user for demo - replace with real auth
  const user = null // Replace with actual auth state
  
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        dropdownRef.current && 
        !dropdownRef.current.contains(event.target as Node) &&
        moreButtonRef.current && 
        !moreButtonRef.current.contains(event.target as Node)
      ) {
        setIsMoreDropdownOpen(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  const handleSignOut = async () => {
    // Implement sign out logic
    navigate('/')
  }

  const isActive = (path: string) => location.pathname === path

  // Base navigation items (always visible)
  const baseNavItems = [
    { path: '/classes', label: 'Classes' },
    { path: '/studios', label: 'Studios' },
    { path: '/membership', label: 'Membership' },
  ]

  // Authenticated user navigation items
  const authNavItems = [
    { path: '/for-you', label: 'For You' },
  ]

  // Combine navigation items based on auth state
  const navItems = user 
    ? [...authNavItems, ...baseNavItems]
    : baseNavItems

  // More dropdown menu items
  const moreMenuItems = [
    { 
      path: '/corporate', 
      label: 'Corporate', 
      icon: Users,
      description: 'Workplace wellness solutions'
    },
    { 
      path: '/partner-with-us', 
      label: 'Partner with Us', 
      icon: Handshake,
      description: 'Join our wellness network'
    },
    { 
      path: '/about', 
      label: 'About', 
      icon: Info,
      description: 'Learn about Solwave'
    },
    { 
      path: '/voucher', 
      label: 'Gift Vouchers', 
      icon: Gift,
      description: 'Give the gift of wellness'
    },
    { 
      path: '/studio/portal', 
      label: 'Studio Portal', 
      icon: Building,
      description: 'For fitness studios'
    },
  ]

  const handleMoreItemClick = (path: string) => {
    setIsMoreDropdownOpen(false)
    navigate(path)
  }

  return (
    <header style={{ 
      backgroundColor: '#F5F3E8', 
      borderBottom: '1px solid rgba(19, 30, 171, 0.1)',
      position: 'sticky',
      top: 0,
      zIndex: 40,
      boxShadow: '0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1)'
    }}>
      <div style={{ maxWidth: '80rem', margin: '0 auto', padding: '0 1rem' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', height: '4rem' }}>
          {/* Official Solwave Logo & Brand */}
          <Link to="/" style={{ textDecoration: 'none' }}>
            <SolwaveHeaderLogo />
          </Link>

          {/* Desktop Navigation */}
          <nav style={{ display: 'none', alignItems: 'center', gap: '0.5rem' }} className="lg:flex">
            {navItems.map((item) => (
              <Link
                key={item.path}
                to={item.path}
                style={{
                  padding: '0.5rem 1rem',
                  borderRadius: '0.375rem',
                  fontSize: '0.875rem',
                  fontWeight: '500',
                  fontFamily: "'Inter', sans-serif",
                  backgroundColor: isActive(item.path) ? '#131EAB' : 'transparent',
                  color: isActive(item.path) ? '#F5F3E8' : '#131EAB',
                  textDecoration: 'none',
                  transition: 'all 0.2s ease'
                }}
                onMouseEnter={(e) => {
                  if (!isActive(item.path)) {
                    e.currentTarget.style.backgroundColor = 'rgba(19, 30, 171, 0.1)'
                  }
                }}
                onMouseLeave={(e) => {
                  if (!isActive(item.path)) {
                    e.currentTarget.style.backgroundColor = 'transparent'
                  }
                }}
              >
                {item.label}
              </Link>
            ))}
            
            {/* More Dropdown */}
            <div style={{ position: 'relative' }}>
              <button
                ref={moreButtonRef}
                onClick={() => setIsMoreDropdownOpen(!isMoreDropdownOpen)}
                style={{
                  padding: '0.5rem 1rem',
                  borderRadius: '0.375rem',
                  fontSize: '0.875rem',
                  fontWeight: '500',
                  fontFamily: "'Inter', sans-serif",
                  backgroundColor: isMoreDropdownOpen ? '#131EAB' : 'transparent',
                  color: isMoreDropdownOpen ? '#F5F3E8' : '#131EAB',
                  border: 'none',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.25rem',
                  transition: 'all 0.2s ease'
                }}
                onMouseEnter={(e) => {
                  if (!isMoreDropdownOpen) {
                    e.currentTarget.style.backgroundColor = 'rgba(19, 30, 171, 0.1)'
                  }
                }}
                onMouseLeave={(e) => {
                  if (!isMoreDropdownOpen) {
                    e.currentTarget.style.backgroundColor = 'transparent'
                  }
                }}
              >
                <span>More</span>
                <ChevronDown 
                  style={{ 
                    width: '1rem', 
                    height: '1rem', 
                    transition: 'transform 0.2s ease',
                    transform: isMoreDropdownOpen ? 'rotate(180deg)' : 'rotate(0deg)'
                  }} 
                />
              </button>
              
              {/* More Dropdown Menu */}
              {isMoreDropdownOpen && (
                <div 
                  ref={dropdownRef}
                  style={{
                    position: 'absolute',
                    right: 0,
                    top: '100%',
                    marginTop: '0.5rem',
                    width: '18rem',
                    backgroundColor: 'white',
                    borderRadius: '0.5rem',
                    boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1)',
                    border: '1px solid rgba(19, 30, 171, 0.1)',
                    zIndex: 50,
                    animation: 'fadeInSlide 0.2s ease-out'
                  }}
                >
                  <div style={{ padding: '0.5rem 0' }}>
                    {moreMenuItems.map((item) => (
                      <button
                        key={item.path}
                        onClick={() => handleMoreItemClick(item.path)}
                        style={{
                          width: '100%',
                          display: 'flex',
                          alignItems: 'center',
                          padding: '0.75rem 1rem',
                          textAlign: 'left',
                          backgroundColor: 'transparent',
                          border: 'none',
                          cursor: 'pointer',
                          transition: 'background-color 0.2s ease'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.backgroundColor = 'rgba(19, 30, 171, 0.05)'
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.backgroundColor = 'transparent'
                        }}
                      >
                        <item.icon style={{ width: '1.25rem', height: '1.25rem', marginRight: '0.75rem', color: 'rgba(19, 30, 171, 0.6)' }} />
                        <div style={{ flex: 1 }}>
                          <div style={{ fontWeight: '500', fontSize: '0.875rem', color: '#131EAB', fontFamily: "'Inter', sans-serif" }}>
                            {item.label}
                          </div>
                          <div style={{ fontSize: '0.75rem', marginTop: '0.125rem', color: 'rgba(19, 30, 171, 0.6)', fontFamily: "'Inter', sans-serif" }}>
                            {item.description}
                          </div>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </nav>

          {/* Desktop Actions */}
          <div style={{ display: 'none', alignItems: 'center', gap: '0.75rem' }} className="lg:flex">
            {user ? (
              <>
                <Link to="/notifications" style={{ position: 'relative', textDecoration: 'none' }}>
                  <button style={{ 
                    padding: '0.5rem', 
                    backgroundColor: 'transparent', 
                    border: 'none', 
                    borderRadius: '0.375rem',
                    cursor: 'pointer',
                    transition: 'background-color 0.2s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = 'rgba(19, 30, 171, 0.1)'
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = 'transparent'
                  }}>
                    <Bell style={{ width: '1.25rem', height: '1.25rem', color: '#131EAB' }} />
                    <span style={{ 
                      position: 'absolute', 
                      top: '-0.25rem', 
                      right: '-0.25rem', 
                      width: '0.75rem', 
                      height: '0.75rem', 
                      borderRadius: '50%', 
                      backgroundColor: '#EDA33C' 
                    }}></span>
                  </button>
                </Link>
                {/* User menu would go here */}
              </>
            ) : (
              <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                <Link 
                  to="/studio/auth"
                  style={{
                    padding: '0.5rem 1rem',
                    border: '1px solid #966748',
                    color: '#966748',
                    backgroundColor: 'transparent',
                    borderRadius: '0.375rem',
                    textDecoration: 'none',
                    fontSize: '0.875rem',
                    fontWeight: '500',
                    fontFamily: "'Inter', sans-serif",
                    transition: 'all 0.2s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = '#966748'
                    e.currentTarget.style.color = 'white'
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = 'transparent'
                    e.currentTarget.style.color = '#966748'
                  }}
                >
                  Studio Portal
                </Link>
                <Link 
                  to="/auth"
                  style={{
                    padding: '0.5rem 1rem',
                    backgroundColor: '#131EAB',
                    color: '#F5F3E8',
                    borderRadius: '0.375rem',
                    textDecoration: 'none',
                    fontSize: '0.875rem',
                    fontWeight: '500',
                    fontFamily: "'Inter', sans-serif",
                    transition: 'background-color 0.2s ease',
                    border: 'none'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = '#0f17a0'
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '#131EAB'
                  }}
                >
                  Get Started
                </Link>
              </div>
            )}
          </div>

          {/* Mobile Menu Button */}
          <button
            onClick={() => setIsMenuOpen(!isMenuOpen)}
            style={{
              display: 'block',
              padding: '0.5rem',
              borderRadius: '0.5rem',
              backgroundColor: 'transparent',
              border: 'none',
              cursor: 'pointer',
              transition: 'background-color 0.2s ease'
            }}
            className="lg:hidden"
            aria-label="Toggle navigation menu"
            onMouseEnter={(e) => {
              e.currentTarget.style.backgroundColor = 'rgba(19, 30, 171, 0.1)'
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.backgroundColor = 'transparent'
            }}
          >
            {isMenuOpen ? 
              <X style={{ width: '1.5rem', height: '1.5rem', color: '#131EAB' }} /> : 
              <Menu style={{ width: '1.5rem', height: '1.5rem', color: '#131EAB' }} />
            }
          </button>
        </div>

        {/* Mobile Navigation */}
        {isMenuOpen && (
          <div style={{ 
            borderTop: '1px solid rgba(19, 30, 171, 0.1)', 
            paddingTop: '1rem', 
            paddingBottom: '1rem',
            animation: 'fadeIn 0.3s ease-out'
          }} className="lg:hidden">
            <nav style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
              {navItems.map((item) => (
                <Link
                  key={item.path}
                  to={item.path}
                  style={{
                    padding: '0.75rem 1rem',
                    borderRadius: '0.5rem',
                    fontSize: '1rem',
                    fontWeight: '500',
                    fontFamily: "'Inter', sans-serif",
                    backgroundColor: isActive(item.path) ? '#131EAB' : 'transparent',
                    color: isActive(item.path) ? '#F5F3E8' : '#131EAB',
                    textDecoration: 'none',
                    transition: 'all 0.2s ease'
                  }}
                  onClick={() => setIsMenuOpen(false)}
                  onMouseEnter={(e) => {
                    if (!isActive(item.path)) {
                      e.currentTarget.style.backgroundColor = 'rgba(19, 30, 171, 0.1)'
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (!isActive(item.path)) {
                      e.currentTarget.style.backgroundColor = 'transparent'
                    }
                  }}
                >
                  {item.label}
                </Link>
              ))}
              
              {/* Mobile More Section */}
              <div style={{ paddingTop: '0.5rem', borderTop: '1px solid rgba(19, 30, 171, 0.1)', marginTop: '1rem' }}>
                <div style={{ 
                  padding: '0.5rem 1rem', 
                  fontSize: '0.75rem', 
                  fontWeight: 'bold', 
                  color: 'rgba(19, 30, 171, 0.6)', 
                  textTransform: 'uppercase', 
                  letterSpacing: '0.05em', 
                  fontFamily: "'Inter', sans-serif" 
                }}>
                  More
                </div>
                {moreMenuItems.map((item) => (
                  <Link
                    key={item.path}
                    to={item.path}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      padding: '0.75rem 1rem',
                      color: '#131EAB',
                      borderRadius: '0.5rem',
                      textDecoration: 'none',
                      transition: 'background-color 0.2s ease',
                      fontFamily: "'Inter', sans-serif"
                    }}
                    onClick={() => setIsMenuOpen(false)}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = 'rgba(19, 30, 171, 0.1)'
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = 'transparent'
                    }}
                  >
                    <item.icon style={{ width: '1.25rem', height: '1.25rem', marginRight: '0.75rem', color: 'rgba(19, 30, 171, 0.6)' }} />
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: '500', color: '#131EAB', fontFamily: "'Inter', sans-serif" }}>
                        {item.label}
                      </div>
                      <div style={{ fontSize: '0.75rem', color: 'rgba(19, 30, 171, 0.6)', fontFamily: "'Inter', sans-serif" }}>
                        {item.description}
                      </div>
                    </div>
                  </Link>
                ))}
              </div>
              
              <div style={{ paddingTop: '1rem', borderTop: '1px solid rgba(19, 30, 171, 0.1)', marginTop: '1rem' }}>
                {user ? (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                    <Link 
                      to="/profile" 
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        padding: '0.75rem 1rem',
                        color: '#131EAB',
                        borderRadius: '0.5rem',
                        textDecoration: 'none',
                        transition: 'background-color 0.2s ease',
                        fontFamily: "'Inter', sans-serif"
                      }}
                      onClick={() => setIsMenuOpen(false)}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = 'rgba(19, 30, 171, 0.1)'
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = 'transparent'
                      }}
                    >
                      <User style={{ width: '1.25rem', height: '1.25rem', marginRight: '0.75rem' }} />
                      Profile
                    </Link>
                    <button 
                      onClick={() => {
                        handleSignOut()
                        setIsMenuOpen(false)
                      }}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        width: '100%',
                        padding: '0.75rem 1rem',
                        color: '#dc3545',
                        backgroundColor: 'transparent',
                        border: 'none',
                        borderRadius: '0.5rem',
                        cursor: 'pointer',
                        transition: 'background-color 0.2s ease',
                        fontFamily: "'Inter', sans-serif"
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#fef2f2'
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = 'transparent'
                      }}
                    >
                      Sign Out
                    </button>
                  </div>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                    <Link 
                      to="/studio/auth" 
                      onClick={() => setIsMenuOpen(false)}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        width: '100%',
                        padding: '0.75rem 1rem',
                        border: '1px solid #966748',
                        color: '#966748',
                        backgroundColor: 'transparent',
                        borderRadius: '0.5rem',
                        textDecoration: 'none',
                        fontWeight: '500',
                        fontFamily: "'Inter', sans-serif",
                        transition: 'all 0.2s ease'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#966748'
                        e.currentTarget.style.color = 'white'
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = 'transparent'
                        e.currentTarget.style.color = '#966748'
                      }}
                    >
                      <Building style={{ width: '1rem', height: '1rem', marginRight: '0.5rem' }} />
                      Studio Portal
                    </Link>
                    <Link 
                      to="/auth" 
                      onClick={() => setIsMenuOpen(false)}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        width: '100%',
                        padding: '0.75rem 1rem',
                        backgroundColor: '#131EAB',
                        color: '#F5F3E8',
                        borderRadius: '0.5rem',
                        textDecoration: 'none',
                        fontWeight: '500',
                        fontFamily: "'Inter', sans-serif",
                        transition: 'background-color 0.2s ease',
                        border: 'none'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = '#0f17a0'
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = '#131EAB'
                      }}
                    >
                      Get Started
                    </Link>
                  </div>
                )}
              </div>
            </nav>
          </div>
        )}
      </div>
    </header>
  )
}
